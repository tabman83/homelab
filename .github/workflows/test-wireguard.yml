name: Test WireGuard Tunnel

on:
  workflow_dispatch:   # manually trigger from GitHub UI
  #push:
    #branches:
      #- main 
jobs:
  test-wireguard:
    runs-on: ubuntu-latest
    env:
      PROXMOX_VE_ENDPOINT:       ${{ secrets.PROXMOX_API_URL }}
      PROXMOX_VE_API_TOKEN:      ${{ secrets.PROXMOX_API_TOKEN_ID }}=${{ secrets.PROXMOX_API_TOKEN_SECRET }}
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}

    steps:
      # Checkout repo so Terraform files are available
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install WireGuard
        run: sudo apt install -y wireguard

      - name: Bring up WireGuard
        run: |
          echo "${{ secrets.WIREGUARD_PRIVATE_KEY }}" > privatekey
          sudo ip link add dev wg0 type wireguard
          sudo ip address add dev wg0 192.168.98.4/32      
          sudo wg set wg0 private-key privatekey peer ${{ secrets.WIREGUARD_PUBLIC_KEY }} allowed-ips 192.168.98.0/24,192.168.5.0/24 endpoint vpn.parisi.cloud:13231
          sudo ip link set up dev wg0
          sudo ip route add 192.168.5.0/24 dev wg0
          sudo resolvectl dns wg0 192.168.5.1
          sudo resolvectl domain wg0 local

      - name: Ensure all referenced LXC templates exist on Proxmox
        env:
          PROXMOX_SSH_KEY: ${{ secrets.PROXMOX_SSH_KEY }}
        run: |
          # 1) Find all ostemplate values in root .tf files (ignore modules/)
          templates=$(grep -hro 'ostemplate *= *"[^"]*"' . --exclude-dir=modules --include='*.tf' \
            | sed -E 's/.*"([^"]*)".*/\1/' \
            | sort -u)

          if [ -z "$templates" ]; then
            echo "No ostemplate entries found in root .tf files. Skipping template ensure."
            exit 0
          fi

          echo "Found ostemplates:"
          echo "$templates"

          # 2) Write SSH key
          mkdir -p ~/.ssh
          echo "$PROXMOX_SSH_KEY" > ~/.ssh/id_proxmox_ci
          chmod 600 ~/.ssh/id_proxmox_ci

          # 3) Run pveam update once
          echo "Updating Proxmox template list (pveam update)..."
          ssh -i ~/.ssh/id_proxmox_ci -o StrictHostKeyChecking=no root@proxmox.local "pveam update"

          # 4) Loop over each template and ensure it exists
          for tpl in $templates; do
            [ -z "$tpl" ] && continue

            storage="${tpl%%:*}"      # e.g. 'local' from 'local:vztmpl/debian-12...'
            path="${tpl#*:}"          # e.g. 'vztmpl/debian-12...'
            filename="${path##*/}"    # e.g. 'debian-12-standard_12.0-1_amd64.tar.zst'

            echo
            echo "Checking template: $tpl"
            echo "  storage = $storage"
            echo "  path    = $path"
            echo "  file    = $filename"

            ssh -i ~/.ssh/id_proxmox_ci -o StrictHostKeyChecking=no root@proxmox.local "
              set -e
              if ! pveam list $storage | awk '{print \$1}' | grep -qx '$tpl'; then
                echo '  -> Missing, downloading via: pveam download $storage $filename'
                pveam download $storage '$filename'
              else
                echo '  -> Already present.'
              fi
            "
          done

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan -out=plan

      - name: Terraform Apply
        if: github.ref == 'refs/heads/master'
        run: terraform apply -auto-approve plan

      - name: Export deploy targets from Terraform
        if: github.ref == 'refs/heads/master'
        run: terraform output -json deploy_targets > deploy_targets.json

      - name: Set up SSH key for Proxmox
        if: github.ref == 'refs/heads/master'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROXMOX_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          cat <<EOF >> ~/.ssh/config
          Host proxmox
          HostName ${PROXMOX_SSH_HOST}
          User ${PROXMOX_SSH_USER}
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
          EOF

      - name: Deploy all apps inside their LXCs
        if: github.ref == 'refs/heads/master'
        run: |
          set -euo pipefail

          # Build HTTPS clone URL for this repo
          REPO_URL="https://github.com/tabman83.git"

          echo "[deploy] Using repo: ${REPO_URL}"
          echo "[deploy] Reading deploy_targets.json..."
          cat deploy_targets.json

          # Each line: app_name:vmid:app_dir
          APPS=$(jq -r 'to_entries[] | "\(.key):\(.value.vmid):\(.value.app_dir)"' deploy_targets.json)

          for entry in $APPS; do
            APP_NAME=$(echo "$entry" | cut -d: -f1)
            VMID=$(echo "$entry"     | cut -d: -f2)
            APP_DIR=$(echo "$entry"  | cut -d: -f3)

            echo "[deploy] Deploying app '${APP_NAME}' to CT ${VMID} (dir: ${APP_DIR})..."

            ssh -i ~/.ssh/id_proxmox_ci -o StrictHostKeyChecking=no root@proxmox.local "REPO_URL=${REPO_URL} APP_NAME=${APP_NAME} VMID=${VMID} APP_DIR=${APP_DIR} bash -s" << 'EOF'
            set -euo pipefail

            # This runs on the Proxmox host
            # Then we exec into the container

            pct exec "$VMID" -- env REPO_URL="$REPO_URL" APP_NAME="$APP_NAME" APP_DIR="$APP_DIR" bash -s << 'INNER'
            set -euo pipefail

            REPO_DIR="/opt/homelab/homelab"
            APP_PATH="${REPO_DIR}/${APP_DIR}"

            echo "[bootstrap:$APP_NAME] Installing prerequisites if needed..."

            if ! command -v git >/dev/null 2>&1; then
              apt-get update
              apt-get install -y ca-certificates curl gnupg git
            fi

            if ! command -v docker >/dev/null 2>&1; then
              install -m 0755 -d /etc/apt/keyrings || true
              if [ ! -f /etc/apt/keyrings/docker.gpg ]; then
                curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                chmod a+r /etc/apt/keyrings/docker.gpg
              fi

              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(. /etc/os-release && echo "$VERSION_CODENAME") stable" > /etc/apt/sources.list.d/docker.list

              apt-get update
              apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            fi

            echo "[bootstrap:$APP_NAME] Cloning or updating repo at $REPO_DIR..."

            mkdir -p "$(dirname "$REPO_DIR")"

            if [ ! -d "$REPO_DIR/.git" ]; then
              rm -rf "$REPO_DIR"
              git clone "$REPO_URL" "$REPO_DIR"
            else
              cd "$REPO_DIR"
              git pull --rebase
            fi

            cd "$APP_PATH"
            chmod +x deploy.sh || true

            echo "[bootstrap:$APP_NAME] Running deploy.sh in $APP_PATH..."
            ./deploy.sh

            echo "[bootstrap:$APP_NAME] Done."
            EOF
          done

      # Bring down the tunnel
      - name: Bring down WireGuard
        if: always()
        run: sudo ip link set down dev wg0
